
/*
        This code is taken from "Hacking: The Art of Exploitation" by Jon Erickson.
        Few modifications are done to make this code suitable for teaching modern
        binary exploitation on both 32 and 64 bit architectures.

        NOTE to Jon Erickson
        Can't thank you enough for writing this amazing book and sharing your
        perspective in the field of binary exploitation. I'm quite sure the world
        continues to learn from your experience !

GCC version - gcc (Debian 12.2.0-14) 12.2.0
â¯ uname -a
Linux kali 6.1.0-kali5-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.12-1kali2 (2023-02-23) x86_64 GNU/Linux

# Prayog 
Now, we want to deliver our payload via environment variables.
Environment variables can be used as an IPC mechanism (Inter-Process Communication) from parent to child process
at the time of invocation of child program (via execve(2)). Shell can be used to pass an env-var to an invoked 
bin. They are present at the bottom of stack (just before the path of invoked binary and a NULL pointer to 
terminate the environment list). On each invocation of a binary, the address of environment variables will vary slightly 
(depending on invoked binary filepath).

To identify what address our SHELLCODE env-var will be present in vulnerable process address space, we find its
address out in this/current experiment program (as both our test and target machines are same, process images
will be created the same manner and env-vars are present at the bottom of stack which makes it certain that they
are less likely to change dynamically or effected by compiler paddings/inconsistencies-added-by-compilers).

$ SHELLCODE=haha ./a.out shellcode 
getenv[SHELL] @ 0x7fffffffec14 : haha 
$ SHELLCODE=haha ./ab.out shellcode 
getenv[SHELL] @ 0x7fffffffec12 : haha 
$ SHELLCODE=haha ./abc.out shellcode 
getenv[SHELL] @ 0x7fffffffec10 : haha 
$ SHELLCODE=haha ./abcd.out SHELLCODE
getenv[SHELL] @ 0x7fffffffec0e : haha 

It is apparent that environemnt variable addresses depend on the invoked binary's name (see the figure below
to understand why this happens). For every character increase in invoked binary's pathname, the address of 
environment variable decreases by 2 bytes. This can be used predict accurate environment variable's addresses 
by -
1> invoke this program to find out address of an environment variable.
2> if filename=>filepath gets modified to some shorter/longer value - then decrease/increase this address by 2 
for every character added to invoked binary's path.

# SET env-var inside GDB
$ shellcode="haha" ./a.out shellcode
(gdb) set env shellcode="haha"

<------- top of stack (current RSP)
...
...
shellcode=haha		<--------- start of environment variables
/home/kali/htaoe/exploitation/003_auth_overflow2.elf	<--------- path of invoked binary
0000000
<------- bottom of stack (0x7ffffffff000)

*/

#include <stdio.h>
#include <stdlib.h>

int main (int argc, char *argv[])
{
	if (argc < 1){
		fprintf (stderr, "[-] Usage: %s <env_var>\n", argv[0]);
		return 1;
	}

	printf ("getenv[%s] @ %p : %s\n", argv[1], getenv(argv[1]), getenv(argv[1]));
}

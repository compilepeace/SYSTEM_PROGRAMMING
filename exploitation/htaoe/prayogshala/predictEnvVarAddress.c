/*

NOTE: This method calculation assumes this program and target program are in exact SAME path in file system.
	  Therefore, execute this program from the same directory where target program is kept.
*/

#define STACK_BOTTOM 0x7ffffffff000

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main (int argc, char **argv)
{
	if (argc < 3){
		fprintf (stderr, "[-] Usage: %s <target_program_argv0> <var_defined_in_your_env>\n", argv[0]);
		fprintf (stderr, "NOTE: 1st argument should specify how you would invoke target software program\n");
		return 7;
	}

	// get value of environment variable inside payload (i.e. shellcode)
	char *payload = getenv(argv[2]);
	if (payload == NULL){
		perror ("getenv");
		return 1;
	}	

	// Go back to memory location -
	// 8 bytes => NULL pointer terminator for env list
	// strlen(argv[1]) - 1 bytes => accounting for full pathname of target program (NULL byte terminated)
	// strlen(payload) - 1 bytes => accounting for shellcode length (NULL byte terminated) 
	char *eVarAddr;
	char *stackBottom = (char *) STACK_BOTTOM; 
	eVarAddr = stackBottom - 8 - (strlen(argv[1]) + 1) - (strlen(payload) + 1);

	printf ("For prog \"%s\": %s (env-var) will be located at %p\n", argv[1], argv[2], eVarAddr);
}
